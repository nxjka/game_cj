<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPGæ¸¸æˆæ•°æ®æ£€æµ‹å™¨ - JSONè½¬Excelè½¬æ¢å™¨</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.2rem;
        }
        
        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            background-color: #f8fafc;
            cursor: pointer;
        }
        
        .upload-area:hover, .upload-area.dragover {
            background-color: #e8f4fc;
            border-color: #2980b9;
            transform: translateY(-5px);
        }
        
        .upload-icon {
            font-size: 64px;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .upload-area p {
            margin-bottom: 15px;
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .btn {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
        }
        
        .btn-success {
            background: #2ecc71;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .btn-warning {
            background: #f39c12;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .file-input {
            display: none;
        }
        
        .results-container {
            margin-top: 30px;
            display: none;
        }
        
        .data-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .data-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
            border-left: 5px solid #3498db;
        }
        
        .data-card:hover {
            transform: translateY(-5px);
        }
        
        .data-card.item {
            border-left-color: #2ecc71;
        }
        
        .data-card.character {
            border-left-color: #e74c3c;
        }
        
        .data-card.event {
            border-left-color: #f39c12;
        }
        
        .data-card.map {
            border-left-color: #9b59b6;
        }
        
        .data-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .data-type {
            font-size: 14px;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .data-type.item {
            background: #2ecc71;
        }
        
        .data-type.character {
            background: #e74c3c;
        }
        
        .data-type.event {
            background: #f39c12;
        }
        
        .data-type.map {
            background: #9b59b6;
        }
        
        .data-count {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .data-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #3498db;
        }
        
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .preview-table th {
            background: #3498db;
            color: white;
            padding: 12px 15px;
            text-align: left;
        }
        
        .preview-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .preview-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .error-message {
            background: #e74c3c;
            color: white;
            padding: 12px 15px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
        }
        
        .success-message {
            background: #2ecc71;
            color: white;
            padding: 12px 15px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom: 3px solid #3498db;
            color: #3498db;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .issues-list {
            margin-top: 20px;
        }
        
        .issue {
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        
        .issue.error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        
        .issue.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .issue.info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
        }
        
        .progress-bar {
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: #3498db;
            border-radius: 5px;
            width: 0%;
            transition: width 0.5s;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>RPGæ¸¸æˆæ•°æ®æ£€æµ‹å™¨</h1>
            <p class="subtitle">å°†JSONæ•°æ®è½¬æ¢ä¸ºExcelè¡¨æ ¼æ ¼å¼</p>
        </header>
        
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">âš”ï¸</div>
            <h3>æ‹–æ‹½RPGæ•°æ®JSONæ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </h3>
            <p>æ”¯æŒç‰©å“ã€äººç‰©ã€äº‹ä»¶ã€åœ°å›¾ç­‰å¤šç§RPGæ•°æ®æ ¼å¼</p>
            <button class="btn" id="browseBtn">é€‰æ‹©æ–‡ä»¶</button>
            <input type="file" id="fileInput" class="file-input" accept=".json" multiple>
        </div>
        
        <div class="loader" id="loader"></div>
        
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        
        <div class="results-container" id="resultsContainer">
            <div class="data-cards" id="dataCards">
                <!-- æ•°æ®å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="preview">æ•°æ®é¢„è§ˆ</div>
                <div class="tab" data-tab="issues">é—®é¢˜æ£€æµ‹</div>
                <div class="tab" data-tab="structure">æ•°æ®ç»“æ„</div>
            </div>
            
            <div class="tab-content active" id="preview">
                <div class="table-container">
                    <table class="preview-table" id="previewTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>åç§°</th>
                                <th>ç±»å‹</th>
                                <th>æè¿°</th>
                                <th>æ•°å€¼</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody">
                            <!-- è¡¨æ ¼æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="issues">
                <h3>æ•°æ®é—®é¢˜æ£€æµ‹</h3>
                <div class="progress-bar">
                    <div class="progress" id="progressBar" style="width: 0%"></div>
                </div>
                <div class="issues-list" id="issuesList">
                    <!-- é—®é¢˜åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                </div>
            </div>
            
            <div class="tab-content" id="structure">
                <h3>æ•°æ®ç»“æ„åˆ†æ</h3>
                <div id="structureViewer">
                    <!-- ç»“æ„åˆ†æå°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                </div>
            </div>
            
            <div class="actions">
                <button class="btn btn-success" id="exportBtn">å¯¼å‡ºExcel</button>
                <button class="btn btn-warning" id="analyzeBtn">åˆ†ææ•°æ®</button>
                <button class="btn" id="resetBtn">é‡ç½®</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–DOMå…ƒç´ 
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const browseBtn = document.getElementById('browseBtn');
            const resultsContainer = document.getElementById('resultsContainer');
            const dataCards = document.getElementById('dataCards');
            const previewTableBody = document.getElementById('previewTableBody');
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            const loader = document.getElementById('loader');
            const exportBtn = document.getElementById('exportBtn');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const resetBtn = document.getElementById('resetBtn');
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const issuesList = document.getElementById('issuesList');
            const progressBar = document.getElementById('progressBar');
            const structureViewer = document.getElementById('structureViewer');
            
            // å­˜å‚¨è§£æåçš„æ•°æ®
            let parsedData = {
                items: [],
                characters: [],
                events: [],
                maps: [],
                others: []
            };
            
            let currentFileIndex = 0;
            let allFiles = [];
            
            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
            browseBtn.addEventListener('click', function() {
                fileInput.click();
            });
            
            // æ–‡ä»¶é€‰æ‹©å˜åŒ–äº‹ä»¶
            fileInput.addEventListener('change', function(e) {
                handleFiles(e.target.files);
            });
            
            // æ‹–æ‹½äº‹ä»¶å¤„ç†
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function() {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
            
            // æ ‡ç­¾é¡µåˆ‡æ¢
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // æ›´æ–°æ´»åŠ¨æ ‡ç­¾
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // æ˜¾ç¤ºå¯¹åº”å†…å®¹
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === tabId) {
                            content.classList.add('active');
                        }
                    });
                });
            });
            
            // å¯¼å‡ºExcel
            exportBtn.addEventListener('click', function() {
                if (isDataEmpty()) {
                    showError('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                    return;
                }
                
                try {
                    // åˆ›å»ºå·¥ä½œç°¿
                    const wb = XLSX.utils.book_new();
                    
                    // ä¸ºæ¯ç§æ•°æ®ç±»å‹åˆ›å»ºå·¥ä½œè¡¨
                    for (const dataType in parsedData) {
                        if (parsedData[dataType].length > 0) {
                            const worksheet = XLSX.utils.json_to_sheet(parsedData[dataType]);
                            XLSX.utils.book_append_sheet(wb, worksheet, capitalizeFirstLetter(dataType));
                        }
                    }
                    
                    // ç”ŸæˆExcelæ–‡ä»¶å¹¶ä¸‹è½½
                    XLSX.writeFile(wb, 'RPG_Data_Analysis.xlsx');
                    showSuccess('Excelæ–‡ä»¶å¯¼å‡ºæˆåŠŸ');
                } catch (error) {
                    showError('å¯¼å‡ºExcelæ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
                }
            });
            
            // åˆ†ææ•°æ®
            analyzeBtn.addEventListener('click', function() {
                analyzeData();
            });
            
            // é‡ç½®
            resetBtn.addEventListener('click', function() {
                fileInput.value = '';
                parsedData = {
                    items: [],
                    characters: [],
                    events: [],
                    maps: [],
                    others: []
                };
                resultsContainer.style.display = 'none';
                errorMessage.style.display = 'none';
                successMessage.style.display = 'none';
                issuesList.innerHTML = '';
                progressBar.style.width = '0%';
            });
            
            // å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
            function handleFiles(files) {
                if (files.length === 0) return;
                
                // é‡ç½®çŠ¶æ€
                parsedData = {
                    items: [],
                    characters: [],
                    events: [],
                    maps: [],
                    others: []
                };
                currentFileIndex = 0;
                allFiles = Array.from(files);
                errorMessage.style.display = 'none';
                successMessage.style.display = 'none';
                
                // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                loader.style.display = 'block';
                resultsContainer.style.display = 'none';
                
                // å¤„ç†æ–‡ä»¶
                processFiles();
            }
            
            // å¤„ç†æ–‡ä»¶é˜Ÿåˆ—
            function processFiles() {
                if (currentFileIndex >= allFiles.length) {
                    // æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆ
                    loader.style.display = 'none';
                    displayResults();
                    return;
                }
                
                const file = allFiles[currentFileIndex];
                
                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                if (!file.name.toLowerCase().endsWith('.json')) {
                    showError(`æ–‡ä»¶ "${file.name}" ä¸æ˜¯JSONæ ¼å¼`);
                    currentFileIndex++;
                    processFiles();
                    return;
                }
                
                // æ£€æŸ¥æ–‡ä»¶å¤§å° (é™åˆ¶5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showError(`æ–‡ä»¶ "${file.name}" è¶…è¿‡5MBé™åˆ¶`);
                    currentFileIndex++;
                    processFiles();
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        categorizeData(jsonData, file.name);
                        
                        currentFileIndex++;
                        processFiles();
                    } catch (error) {
                        showError(`æ–‡ä»¶ "${file.name}" è§£æå¤±è´¥: ${error.message}`);
                        currentFileIndex++;
                        processFiles();
                    }
                };
                
                reader.onerror = function() {
                    showError(`è¯»å–æ–‡ä»¶ "${file.name}" æ—¶å‘ç”Ÿé”™è¯¯`);
                    currentFileIndex++;
                    processFiles();
                };
                
                reader.readAsText(file);
            }
            
            // åˆ†ç±»æ•°æ®
            function categorizeData(data, fileName) {
                // å¦‚æœæ•°æ®æ˜¯æ•°ç»„ï¼Œå¤„ç†æ¯ä¸ªå…ƒç´ 
                if (Array.isArray(data)) {
                    data.forEach(item => {
                        addToCategory(item, fileName);
                    });
                } else {
                    // å¦‚æœæ•°æ®æ˜¯å¯¹è±¡ï¼Œç›´æ¥å¤„ç†
                    addToCategory(data, fileName);
                }
            }
            
            // å°†æ•°æ®æ·»åŠ åˆ°ç›¸åº”ç±»åˆ«
            function addToCategory(item, fileName) {
                // æ·»åŠ æ–‡ä»¶åä¿¡æ¯
                item.sourceFile = fileName;
                
                // æ ¹æ®æ•°æ®ç‰¹å¾åˆ¤æ–­ç±»å‹
                if (item.type === 'item' || item.itemType || item.equipmentSlot) {
                    parsedData.items.push(item);
                } else if (item.type === 'character' || item.characterClass || item.level) {
                    parsedData.characters.push(item);
                } else if (item.type === 'event' || item.eventType || item.trigger) {
                    parsedData.events.push(item);
                } else if (item.type === 'map' || item.mapType || item.coordinates) {
                    parsedData.maps.push(item);
                } else {
                    parsedData.others.push(item);
                }
            }
            
            // æ˜¾ç¤ºè§£æç»“æœ
            function displayResults() {
                if (isDataEmpty()) {
                    showError('æ²¡æœ‰æˆåŠŸè§£æä»»ä½•æ•°æ®');
                    return;
                }
                
                // æ›´æ–°æ•°æ®å¡ç‰‡
                updateDataCards();
                
                // æ›´æ–°é¢„è§ˆè¡¨æ ¼
                updatePreviewTable();
                
                // æ˜¾ç¤ºç»“æœå®¹å™¨
                resultsContainer.style.display = 'block';
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                const totalItems = getTotalItems();
                showSuccess(`æˆåŠŸè§£æ ${allFiles.length} ä¸ªæ–‡ä»¶ï¼Œå…± ${totalItems} æ¡æ•°æ®è®°å½•`);
            }
            
            // æ›´æ–°æ•°æ®å¡ç‰‡
            function updateDataCards() {
                dataCards.innerHTML = '';
                
                const categories = [
                    { key: 'items', name: 'ç‰©å“', icon: 'ğŸ›¡ï¸' },
                    { key: 'characters', name: 'äººç‰©', icon: 'ğŸ§™' },
                    { key: 'events', name: 'äº‹ä»¶', icon: 'ğŸ“œ' },
                    { key: 'maps', name: 'åœ°å›¾', icon: 'ğŸ—ºï¸' },
                    { key: 'others', name: 'å…¶ä»–', icon: 'ğŸ“' }
                ];
                
                categories.forEach(category => {
                    if (parsedData[category.key].length > 0) {
                        const card = document.createElement('div');
                        card.className = `data-card ${category.key}`;
                        
                        const stats = calculateStats(parsedData[category.key]);
                        
                        card.innerHTML = `
                            <div class="data-card-header">
                                <div>
                                    <h3>${category.icon} ${category.name}</h3>
                                    <div class="data-type ${category.key}">${category.name}</div>
                                </div>
                                <div class="data-count">${parsedData[category.key].length}</div>
                            </div>
                            <div class="data-stats">
                                <div class="stat">
                                    <div class="stat-value">${stats.uniqueKeys}</div>
                                    <div class="stat-label">å”¯ä¸€å­—æ®µ</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value">${stats.avgProps}</div>
                                    <div class="stat-label">å¹³å‡å±æ€§</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value">${stats.maxDepth}</div>
                                    <div class="stat-label">æœ€å¤§æ·±åº¦</div>
                                </div>
                            </div>
                        `;
                        
                        dataCards.appendChild(card);
                    }
                });
            }
            
            // æ›´æ–°é¢„è§ˆè¡¨æ ¼
            function updatePreviewTable() {
                previewTableBody.innerHTML = '';
                
                // åˆå¹¶æ‰€æœ‰æ•°æ®ç”¨äºé¢„è§ˆï¼ˆé™åˆ¶å‰50æ¡ï¼‰
                const allData = [
                    ...parsedData.items.slice(0, 10),
                    ...parsedData.characters.slice(0, 10),
                    ...parsedData.events.slice(0, 10),
                    ...parsedData.maps.slice(0, 10),
                    ...parsedData.others.slice(0, 10)
                ];
                
                allData.forEach(item => {
                    const row = document.createElement('tr');
                    
                    // è·å–ID
                    const id = item.id || item.itemId || item.characterId || item.eventId || item.mapId || 'N/A';
                    
                    // è·å–åç§°
                    const name = item.name || item.itemName || item.characterName || item.eventName || item.mapName || 'æœªå‘½å';
                    
                    // è·å–ç±»å‹
                    let type = 'æœªçŸ¥';
                    if (parsedData.items.includes(item)) type = 'ç‰©å“';
                    else if (parsedData.characters.includes(item)) type = 'äººç‰©';
                    else if (parsedData.events.includes(item)) type = 'äº‹ä»¶';
                    else if (parsedData.maps.includes(item)) type = 'åœ°å›¾';
                    else type = 'å…¶ä»–';
                    
                    // è·å–æè¿°
                    const description = item.description || item.desc || item.info || 'æ— æè¿°';
                    
                    // è·å–æ•°å€¼ï¼ˆå°è¯•æ‰¾åˆ°æœ‰æ„ä¹‰çš„æ•°å€¼å­—æ®µï¼‰
                    let value = 'N/A';
                    if (item.value !== undefined) value = item.value;
                    else if (item.price !== undefined) value = item.price;
                    else if (item.cost !== undefined) value = item.cost;
                    else if (item.power !== undefined) value = item.power;
                    else if (item.level !== undefined) value = item.level;
                    
                    row.innerHTML = `
                        <td>${id}</td>
                        <td>${name}</td>
                        <td>${type}</td>
                        <td>${truncateText(description, 50)}</td>
                        <td>${value}</td>
                    `;
                    
                    previewTableBody.appendChild(row);
                });
            }
            
            // åˆ†ææ•°æ®
            function analyzeData() {
                if (isDataEmpty()) {
                    showError('æ²¡æœ‰å¯åˆ†æçš„æ•°æ®');
                    return;
                }
                
                issuesList.innerHTML = '';
                progressBar.style.width = '0%';
                
                // æ¨¡æ‹Ÿåˆ†æè¿›åº¦
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 5;
                    progressBar.style.width = `${progress}%`;
                    
                    if (progress >= 100) {
                        clearInterval(interval);
                        performDataAnalysis();
                    }
                }, 100);
            }
            
            // æ‰§è¡Œæ•°æ®åˆ†æ
            function performDataAnalysis() {
                const issues = [];
                
                // æ£€æŸ¥ç‰©å“æ•°æ®
                parsedData.items.forEach(item => {
                    if (!item.id) {
                        issues.push({
                            type: 'error',
                            message: `ç‰©å“ "${item.name || 'æœªå‘½å'}" ç¼ºå°‘ID`,
                            category: 'ç‰©å“'
                        });
                    }
                    
                    if (!item.name) {
                        issues.push({
                            type: 'warning',
                            message: `ç‰©å“(ID: ${item.id || 'æœªçŸ¥'}) ç¼ºå°‘åç§°`,
                            category: 'ç‰©å“'
                        });
                    }
                    
                    if (item.value === undefined) {
                        issues.push({
                            type: 'warning',
                            message: `ç‰©å“ "${item.name || 'æœªå‘½å'}" ç¼ºå°‘ä»·å€¼å±æ€§`,
                            category: 'ç‰©å“'
                        });
                    }
                });
                
                // æ£€æŸ¥äººç‰©æ•°æ®
                parsedData.characters.forEach(character => {
                    if (!character.id) {
                        issues.push({
                            type: 'error',
                            message: `äººç‰© "${character.name || 'æœªå‘½å'}" ç¼ºå°‘ID`,
                            category: 'äººç‰©'
                        });
                    }
                    
                    if (!character.name) {
                        issues.push({
                            type: 'warning',
                            message: `äººç‰©(ID: ${character.id || 'æœªçŸ¥'}) ç¼ºå°‘åç§°`,
                            category: 'äººç‰©'
                        });
                    }
                    
                    if (character.level === undefined) {
                        issues.push({
                            type: 'info',
                            message: `äººç‰© "${character.name || 'æœªå‘½å'}" ç¼ºå°‘ç­‰çº§å±æ€§`,
                            category: 'äººç‰©'
                        });
                    }
                });
                
                // æ£€æŸ¥é‡å¤ID
                const allIds = {};
                
                for (const category in parsedData) {
                    parsedData[category].forEach(item => {
                        if (item.id) {
                            if (!allIds[item.id]) {
                                allIds[item.id] = [];
                            }
                            allIds[item.id].push({
                                name: item.name || 'æœªå‘½å',
                                category: category
                            });
                        }
                    });
                }
                
                for (const id in allIds) {
                    if (allIds[id].length > 1) {
                        issues.push({
                            type: 'error',
                            message: `ID "${id}" åœ¨å¤šä¸ªæ¡ç›®ä¸­é‡å¤ä½¿ç”¨: ${allIds[id].map(i => `${i.name}(${i.category})`).join(', ')}`,
                            category: 'æ•°æ®å®Œæ•´æ€§'
                        });
                    }
                }
                
                // æ˜¾ç¤ºé—®é¢˜
                displayIssues(issues);
                
                // æ›´æ–°ç»“æ„åˆ†æ
                updateStructureAnalysis();
            }
            
            // æ˜¾ç¤ºé—®é¢˜åˆ—è¡¨
            function displayIssues(issues) {
                if (issues.length === 0) {
                    issuesList.innerHTML = '<div class="issue info">æœªå‘ç°æ•°æ®é—®é¢˜</div>';
                    return;
                }
                
                issues.forEach(issue => {
                    const issueElement = document.createElement('div');
                    issueElement.className = `issue ${issue.type}`;
                    issueElement.innerHTML = `
                        <strong>${issue.category}</strong>: ${issue.message}
                    `;
                    issuesList.appendChild(issueElement);
                });
            }
            
            // æ›´æ–°ç»“æ„åˆ†æ
            function updateStructureAnalysis() {
                let structureHTML = '';
                
                for (const category in parsedData) {
                    if (parsedData[category].length > 0) {
                        structureHTML += `<h4>${capitalizeFirstLetter(category)} æ•°æ®ç»“æ„</h4>`;
                        
                        const sample = parsedData[category][0];
                        const keys = Object.keys(sample);
                        
                        structureHTML += `<p>å­—æ®µæ•°é‡: ${keys.length}</p>`;
                        structureHTML += `<ul>`;
                        
                        keys.forEach(key => {
                            const value = sample[key];
                            const type = typeof value;
                            structureHTML += `<li><strong>${key}</strong>: ${type} ${Array.isArray(value) ? '(æ•°ç»„)' : ''} ${value === null ? '(ç©ºå€¼)' : ''}</li>`;
                        });
                        
                        structureHTML += `</ul>`;
                    }
                }
                
                structureViewer.innerHTML = structureHTML;
            }
            
            // å·¥å…·å‡½æ•°
            function isDataEmpty() {
                for (const category in parsedData) {
                    if (parsedData[category].length > 0) {
                        return false;
                    }
                }
                return true;
            }
            
            function getTotalItems() {
                let total = 0;
                for (const category in parsedData) {
                    total += parsedData[category].length;
                }
                return total;
            }
            
            function calculateStats(data) {
                if (data.length === 0) return { uniqueKeys: 0, avgProps: 0, maxDepth: 0 };
                
                // æ”¶é›†æ‰€æœ‰å”¯ä¸€é”®
                const allKeys = new Set();
                let totalProps = 0;
                let maxDepth = 0;
                
                data.forEach(item => {
                    const keys = Object.keys(item);
                    keys.forEach(key => allKeys.add(key));
                    totalProps += keys.length;
                    
                    // è®¡ç®—åµŒå¥—æ·±åº¦
                    const depth = calculateObjectDepth(item);
                    if (depth > maxDepth) maxDepth = depth;
                });
                
                return {
                    uniqueKeys: allKeys.size,
                    avgProps: Math.round(totalProps / data.length),
                    maxDepth: maxDepth
                };
            }
            
            function calculateObjectDepth(obj) {
                if (typeof obj !== 'object' || obj === null) return 0;
                
                let depth = 0;
                for (const key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        const childDepth = calculateObjectDepth(obj[key]);
                        depth = Math.max(depth, childDepth);
                    }
                }
                
                return depth + 1;
            }
            
            function truncateText(text, maxLength) {
                if (text.length <= maxLength) return text;
                return text.substring(0, maxLength) + '...';
            }
            
            function capitalizeFirstLetter(string) {
                return string.charAt(0).toUpperCase() + string.slice(1);
            }
            
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                successMessage.style.display = 'none';
            }
            
            function showSuccess(message) {
                successMessage.textContent = message;
                successMessage.style.display = 'block';
                errorMessage.style.display = 'none';
            }
        });
    </script>
</body>
</html>